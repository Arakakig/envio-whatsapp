<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste - Contexto de Conversas</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .conversation-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border: 1px solid #ddd;
            margin: 5px 0;
            border-radius: 4px;
            background-color: #f9f9f9;
        }
        .conversation-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 15px;
            background-color: #007bff;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        .conversation-info {
            flex: 1;
        }
        .conversation-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .conversation-phone {
            color: #666;
            font-size: 0.9em;
        }
        .conversation-status {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-left: 10px;
        }
        .status-open {
            background-color: #ffc107;
            color: #000;
        }
        .status-closed {
            background-color: #6c757d;
            color: white;
        }
        .unread-badge {
            background-color: #dc3545;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            margin-left: 10px;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 0.9em;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Teste - Contexto de Conversas</h1>
        <p>Este arquivo testa se o contexto global de conversas est√° funcionando corretamente com nomes e fotos de perfil.</p>

        <div class="test-section">
            <h3>üìä Status do Sistema</h3>
            <div id="systemStatus" class="status info">
                Verificando status do sistema...
            </div>
            <button onclick="checkSystemStatus()">Verificar Status</button>
        </div>

        <div class="test-section">
            <h3>üîç Teste de Busca de Conversas</h3>
            <div id="conversationsStatus" class="status info">
                Aguardando teste...
            </div>
            <button onclick="testFetchConversations()">Buscar Conversas</button>
            <button onclick="testConversationContext()">Testar Contexto</button>
        </div>

        <div class="test-section">
            <h3>üì± Lista de Conversas</h3>
            <div id="conversationsList">
                <div class="status info">Clique em "Buscar Conversas" para carregar a lista</div>
            </div>
        </div>

        <div class="test-section">
            <h3>üìù Logs de Debug</h3>
            <div id="debugLog" class="log">
                Logs aparecer√£o aqui...
            </div>
            <button onclick="clearLog()">Limpar Log</button>
        </div>

        <div class="test-section">
            <h3>üîî Teste de Notifica√ß√µes</h3>
            <div id="notificationStatus" class="status info">
                Aguardando teste de notifica√ß√µes...
            </div>
            <button onclick="testNotifications()">Testar Notifica√ß√µes</button>
            <button onclick="testConversationMessage()">Simular Mensagem de Conversa</button>
        </div>
    </div>

    <script>
        let debugLog = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            debugLog.push(logEntry);
            
            const logElement = document.getElementById('debugLog');
            logElement.innerHTML = debugLog.join('<br>');
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(logEntry);
        }

        function clearLog() {
            debugLog = [];
            document.getElementById('debugLog').innerHTML = 'Logs limpos...';
        }

        function updateStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
        }

        async function checkSystemStatus() {
            log('Verificando status do sistema...');
            updateStatus('systemStatus', 'Verificando...', 'info');

            try {
                const response = await fetch('http://localhost:3001/api/test');
                const data = await response.json();
                
                if (data.success) {
                    updateStatus('systemStatus', '‚úÖ Sistema funcionando corretamente', 'success');
                    log('Sistema funcionando corretamente');
                } else {
                    updateStatus('systemStatus', '‚ùå Erro no sistema', 'error');
                    log('Erro no sistema: ' + data.error, 'error');
                }
            } catch (error) {
                updateStatus('systemStatus', '‚ùå Erro de conex√£o: ' + error.message, 'error');
                log('Erro de conex√£o: ' + error.message, 'error');
            }
        }

        async function testFetchConversations() {
            log('Testando busca de conversas...');
            updateStatus('conversationsStatus', 'Buscando conversas...', 'info');

            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    updateStatus('conversationsStatus', '‚ùå Token n√£o encontrado. Fa√ßa login primeiro.', 'error');
                    log('Token n√£o encontrado', 'error');
                    return;
                }

                const response = await fetch('http://localhost:3001/api/attendance/dashboard', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();
                
                if (data.success) {
                    updateStatus('conversationsStatus', `‚úÖ ${data.recentConversations.length} conversas encontradas`, 'success');
                    log(`Encontradas ${data.recentConversations.length} conversas`);
                    
                    // Exibir conversas
                    displayConversations(data.recentConversations);
                    
                    // Verificar se tem nomes e fotos
                    const withNames = data.recentConversations.filter(c => c.contactName || c.customer_name);
                    const withPhotos = data.recentConversations.filter(c => c.profilePicture);
                    
                    log(`Conversas com nomes: ${withNames.length}/${data.recentConversations.length}`);
                    log(`Conversas com fotos: ${withPhotos.length}/${data.recentConversations.length}`);
                    
                    if (withNames.length === 0) {
                        log('‚ö†Ô∏è Nenhuma conversa tem nome de contato', 'error');
                    }
                    if (withPhotos.length === 0) {
                        log('‚ö†Ô∏è Nenhuma conversa tem foto de perfil', 'error');
                    }
                } else {
                    updateStatus('conversationsStatus', '‚ùå Erro ao buscar conversas: ' + data.error, 'error');
                    log('Erro ao buscar conversas: ' + data.error, 'error');
                }
            } catch (error) {
                updateStatus('conversationsStatus', '‚ùå Erro de conex√£o: ' + error.message, 'error');
                log('Erro de conex√£o: ' + error.message, 'error');
            }
        }

        function displayConversations(conversations) {
            const container = document.getElementById('conversationsList');
            
            if (conversations.length === 0) {
                container.innerHTML = '<div class="status info">Nenhuma conversa encontrada</div>';
                return;
            }

            const html = conversations.map(conv => {
                const name = conv.contactName || conv.customer_name || 'Cliente';
                const phone = conv.customer_phone || 'Sem telefone';
                const status = conv.status || 'unknown';
                const hasUnread = conv.has_unread_messages || false;
                const photo = conv.profilePicture;
                
                return `
                    <div class="conversation-item">
                        <div class="conversation-avatar">
                            ${photo ? `<img src="${photo}" alt="${name}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">` : 'üë§'}
                        </div>
                        <div class="conversation-info">
                            <div class="conversation-name">${name}</div>
                            <div class="conversation-phone">${phone}</div>
                        </div>
                        <span class="conversation-status status-${status}">${status}</span>
                        ${hasUnread ? '<div class="unread-badge">!</div>' : ''}
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        async function testConversationContext() {
            log('Testando contexto de conversas...');
            
            try {
                // Verificar se o contexto est√° dispon√≠vel
                const token = localStorage.getItem('token');
                if (!token) {
                    log('Token n√£o encontrado', 'error');
                    return;
                }

                // Testar se as conversas est√£o sendo carregadas corretamente
                const response = await fetch('http://localhost:3001/api/attendance/dashboard', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();
                
                if (data.success) {
                    log(`Contexto carregou ${data.recentConversations.length} conversas`);
                    
                    // Verificar campos importantes
                    const sampleConversation = data.recentConversations[0];
                    if (sampleConversation) {
                        log('Campos da primeira conversa:');
                        log(`- ID: ${sampleConversation.id}`);
                        log(`- Nome: ${sampleConversation.contactName || sampleConversation.customer_name || 'N/A'}`);
                        log(`- Telefone: ${sampleConversation.customer_phone || 'N/A'}`);
                        log(`- Foto: ${sampleConversation.profilePicture ? 'Sim' : 'N√£o'}`);
                        log(`- Status: ${sampleConversation.status || 'N/A'}`);
                        log(`- N√£o lida: ${sampleConversation.has_unread_messages ? 'Sim' : 'N√£o'}`);
                    }
                }
            } catch (error) {
                log('Erro ao testar contexto: ' + error.message, 'error');
            }
        }

        async function testNotifications() {
            log('Testando sistema de notifica√ß√µes...');
            updateStatus('notificationStatus', 'Testando notifica√ß√µes...', 'info');

            try {
                // Verificar permiss√£o de notifica√ß√£o
                if ('Notification' in window) {
                    if (Notification.permission === 'granted') {
                        log('Permiss√£o de notifica√ß√£o concedida');
                        updateStatus('notificationStatus', '‚úÖ Notifica√ß√µes funcionando', 'success');
                    } else if (Notification.permission === 'denied') {
                        log('Permiss√£o de notifica√ß√£o negada', 'error');
                        updateStatus('notificationStatus', '‚ùå Permiss√£o de notifica√ß√£o negada', 'error');
                    } else {
                        log('Solicitando permiss√£o de notifica√ß√£o...');
                        const permission = await Notification.requestPermission();
                        if (permission === 'granted') {
                            log('Permiss√£o concedida');
                            updateStatus('notificationStatus', '‚úÖ Notifica√ß√µes funcionando', 'success');
                        } else {
                            log('Permiss√£o negada', 'error');
                            updateStatus('notificationStatus', '‚ùå Permiss√£o negada', 'error');
                        }
                    }
                } else {
                    log('Notifica√ß√µes n√£o suportadas pelo navegador', 'error');
                    updateStatus('notificationStatus', '‚ùå Notifica√ß√µes n√£o suportadas', 'error');
                }
            } catch (error) {
                log('Erro ao testar notifica√ß√µes: ' + error.message, 'error');
                updateStatus('notificationStatus', '‚ùå Erro: ' + error.message, 'error');
            }
        }

        async function testConversationMessage() {
            log('Simulando mensagem de conversa...');
            
            try {
                // Simular evento de mensagem
                const testMessage = {
                    type: 'message',
                    conversationId: 1,
                    message: 'Mensagem de teste do cliente',
                    from: '5511999999999@c.us',
                    timestamp: new Date().toISOString()
                };

                log('Enviando evento de teste: ' + JSON.stringify(testMessage));
                
                // Emitir evento via WebSocket se dispon√≠vel
                if (window.io) {
                    const socket = io('http://localhost:3001');
                    socket.emit('test-conversation-message', testMessage);
                    log('Evento enviado via WebSocket');
                } else {
                    log('WebSocket n√£o dispon√≠vel, simulando apenas no log');
                }

                // Simular notifica√ß√£o do navegador
                if ('Notification' in window && Notification.permission === 'granted') {
                    new Notification('Nova Mensagem de Cliente', {
                        body: 'Mensagem de teste do cliente',
                        icon: 'http://localhost:3001/vite.svg'
                    });
                    log('Notifica√ß√£o do navegador enviada');
                }

                updateStatus('notificationStatus', '‚úÖ Teste de mensagem conclu√≠do', 'success');
            } catch (error) {
                log('Erro ao testar mensagem: ' + error.message, 'error');
                updateStatus('notificationStatus', '‚ùå Erro: ' + error.message, 'error');
            }
        }

        // Carregar Socket.IO se dispon√≠vel
        function loadSocketIO() {
            const script = document.createElement('script');
            script.src = 'http://localhost:3001/socket.io/socket.io.js';
            script.onload = () => {
                log('Socket.IO carregado com sucesso');
            };
            script.onerror = () => {
                log('Erro ao carregar Socket.IO', 'error');
            };
            document.head.appendChild(script);
        }

        // Inicializar
        window.onload = function() {
            log('P√°gina carregada, iniciando testes...');
            loadSocketIO();
            checkSystemStatus();
        };
    </script>
</body>
</html> 